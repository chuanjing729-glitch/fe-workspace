# webpack-coverage-plugin 核心方案设计需求文档

## 1. 概述

### 1.1 目的
本文档旨在定义 webpack-coverage-plugin 工具的需求，该工具目标是在 DevServer 启动时动态插桩，实时收集覆盖率，并与 Git Diff 结合，生成"增量自测报告"。

### 1.2 范围
本工具将集成到现有的 webpack-coverage-plugin 架构中，提供开发阶段的自测覆盖率追踪功能。

## 2. 功能需求

### 2.1 核心链路架构

#### 2.1.1 编译期 (Compile Time)
- 基于 babel-plugin-istanbul 或原生的 SWC/Esbuild 插件
- 在 Webpack/Vite 编译流水线中对代码进行 AST 注入

#### 2.1.2 运行时 (Runtime)
- 在浏览器 window 对象下挂载 __coverage__ 对象
- 记录每一行、每一个分支的执行状态

#### 2.1.3 数据采集 (Data Collection)
- 开发者完成一次业务流自测后，通过悬浮控制台或快捷键
- 将内存中的覆盖率数据发送给本地 Node.js 服务

#### 2.1.4 报告映射 (Mapping & Diff)
- 工具读取本地 .git 信息
- 计算 current-branch 与 master 的 Diff
- 过滤出增量代码块，生成"增量自测完成度"仪表盘

### 2.2 关键细节设计

#### 2.2.1 动态插桩与性能平衡
- 按需插桩：支持配置只对 src/ 下非 node_modules 代码进行插桩
- 环境隔离：通过环境变量 ENABLE_SELF_TEST=true 开启，避免生产打包时泄露插桩代码

#### 2.2.2 增量代码识别 (AST + Git)
- 行级 Diff：通过 git diff -U0 获取当前分支改动的行号
- AST 关联：将覆盖率数据中的 statementMap 和 branchMap 位置信息，与 Git Diff 的行号区间进行交集计算
- 结果输出：
  - 绿色：新增逻辑已跑通
  - 红色：新增逻辑（如 if 的 else 分支、catch 块）从未进入，这是线上问题的重灾区

#### 2.2.3 "开发者友好"的交互界面 (The Overlay)
- 实时进度条：显示当前 Buffer 中的增量覆盖率百分比
- 高亮模式：点击开关，直接在当前页面源码上（SourceMap 还原后）高亮未覆盖的逻辑块
- 一键导出：生成一个 JSON 或 HTML，作为 MR（合并请求）的强制附件，证明已完成自测
- 运行时小气泡：在页面右下角显示一个友好的悬浮气泡，点击后可查看增量代码自测进度，包括：
  - 当前页面/组件的覆盖率进度
  - 未覆盖的代码块列表
  - 自测建议和提醒
  - 快捷操作按钮（如导出报告、刷新数据等）

### 2.3 增强报告功能

#### 2.3.1 开发者信息
报告应包含以下开发者相关信息：
- Git 用户名 (gitname)
- 当前提交哈希 (githash)
- 当前分支名称 (current branch)
- 硬件信息 (hardware information)

#### 2.3.2 测试汇总信息
报告应包含以下测试汇总信息：
- 总测试数量
- 通过测试数量
- 失败测试数量
- 测试通过率

#### 2.3.3 代码信息汇总
报告应包含以下代码相关信息：
- 提交代码量
- 代码复杂度
- 重要代码的重要程度评估

#### 2.3.4 业务信息汇总
报告应包含以下业务相关信息，以表格形式展示：
- 页面名称
- 组件名称
- 编写代码行数
- 自测总数
- 自测通过数
- 严重等级（用于判断是否放行）
- 影响范围分析：
  - 受影响的页面列表
  - 受影响的组件列表
  - 影响程度评估（高/中/低）
  - 影响传播路径分析
  - 回归测试建议

## 3. 技术实现路线

### 3.1 第一阶段：数据捕获 (The Collector)
- 利用 babel-plugin-istanbul 实现核心逻辑
- 支持 JavaScript、TypeScript 等文件类型
- 可选：结合 Git 仅对当前变动的文件进行插桩以提升速度
- 收集开发者环境信息（Git信息、硬件信息等）
- 分析代码依赖关系，识别潜在的影响范围

### 3.2 第二阶段：本地报告服务 (The Local Server)
- 在 Webpack 插件的 apply 方法中，利用 devServer.before 拦截 API
- POST /__coverage_upload：接收浏览器发回的覆盖率数据
- 调用 istanbul-reports 生成 HTML，并自动对比 Git Diff
- 生成增强版报告，包含开发者信息、测试汇总、代码信息和业务信息
- 注入运行时小气泡 UI 组件到页面中，实时显示覆盖率进度
- 基于代码依赖分析生成影响范围报告

### 3.3 第三阶段：门禁集成 (The Gatekeeper)
- 在 specs 规范中增加一条："无自测报告，不准提交"
- 使用 husky 在 pre-commit 阶段检查本地是否存在符合标准的自测覆盖率数据
- 增量分支覆盖率 > 80% 作为最低要求
- 基于报告中的严重等级判断是否放行代码提交

## 4. 非功能需求

### 4.1 性能要求
- 不影响本地开发 HMR（热更新）速度
- 插桩代码在生产环境中不可见

### 4.2 兼容性要求
- 支持 Webpack 和 Vite 构建工具
- 支持主流浏览器

### 4.3 安全性要求
- 确保覆盖率数据仅在本地环境中传输和存储
- 避免敏感信息泄露

## 5. 验收标准

### 5.1 功能验收标准
- 能够正确插桩并收集覆盖率数据
- 能够准确识别增量代码并生成报告
- 提供友好的开发者交互界面
- 集成到 Git 提交门禁流程
- 生成包含开发者信息、测试汇总、代码信息和业务信息的增强版报告
- 在页面中显示运行时小气泡，实时显示覆盖率进度
- 生成影响范围分析报告，包含受影响的页面和组件列表

### 5.2 功能详细要求

#### 5.2.1 报告内容要求

##### 开发者信息部分
- Git 用户名：通过 `git config user.name` 获取
- 当前提交哈希：通过 `git rev-parse HEAD` 获取
- 当前分支名称：通过 `git branch --show-current` 获取
- 硬件信息：包括操作系统、CPU 核心数、内存大小等

##### 测试汇总部分
- 总测试数量：统计所有执行的测试用例数量
- 通过测试数量：统计成功执行的测试用例数量
- 失败测试数量：统计执行失败的测试用例数量
- 测试通过率：计算通过测试占总测试的比例

##### 代码信息部分
- 提交代码量：统计本次提交涉及的代码行数
- 代码复杂度：基于圈复杂度等指标评估代码复杂度
- 重要代码重要程度：根据代码位置、调用频率等因素评估重要程度

##### 业务信息部分
- 页面名称：涉及的前端页面名称
- 组件名称：涉及的组件名称
- 编写代码行数：每个组件/页面的代码行数统计
- 自测总数：针对每个组件/页面执行的自测用例数量
- 自测通过数：针对每个组件/页面成功执行的自测用例数量
- 严重等级：根据代码重要性和测试覆盖率评估严重等级（高/中/低）
- 影响范围分析：
  - 受影响的页面列表：列出受本次代码变更影响的所有页面
  - 受影响的组件列表：列出受本次代码变更影响的所有组件
  - 影响程度评估：根据依赖关系和调用频率评估影响程度（高/中/低）
  - 影响传播路径分析：展示代码变更如何传播到其他组件或页面
  - 回归测试建议：基于影响范围提供回归测试的优先级建议

#### 5.2.2 报告格式要求
- 支持 HTML 和 Markdown 双格式输出
- HTML 格式应具有良好的可视化效果和交互性，包含以下图表元素：
  - 饼图：展示测试通过率分布
  - 柱状图：展示各组件/页面的代码行数和测试覆盖率
  - 进度条：直观显示整体测试进度
  - 热力图：展示代码复杂度分布
- Markdown 格式应结构清晰，便于版本控制和文档管理
- 业务信息部分应以表格形式展示，便于阅读和分析

#### 5.2.3 报告生成要求
- 报告应在每次构建完成后自动生成
- 报告生成时间不应超过 5 秒
- 报告应保存在指定目录下，支持自定义路径配置

#### 5.2.4 运行时小气泡要求
- 在页面右下角显示悬浮气泡，不遮挡页面内容
- 气泡应包含以下信息：
  - 当前页面/组件的覆盖率百分比
  - 未覆盖的代码块数量
  - 自测进度状态（如：进行中、已完成、需改进）
- 点击气泡后展开详细信息面板，显示：
  - 详细的覆盖率统计数据
  - 未覆盖的代码块列表
  - 自测建议和提醒
  - 快捷操作按钮（导出报告、刷新数据等）
- 气泡应支持拖拽移动，方便开发者调整位置
- 气泡应支持最小化/隐藏，避免干扰正常开发
- 气泡样式应与主流设计风格保持一致，美观且不突兀

### 5.3 性能验收标准
- HMR 热更新延迟增加不超过 10%
- 内存占用合理，不影响开发体验
- 报告生成时间不超过 5 秒

### 5.4 部署验收标准
- 易于集成到现有项目中
- 提供清晰的配置文档
- 报告格式支持 HTML 和 Markdown 双格式

## 6. 配置选项

### 6.1 基础配置

| 选项 | 类型 | 默认值 | 描述 |
|------|------|--------|------|
| enabled | boolean | `process.env.ENABLE_SELF_TEST === 'true'` | 是否启用插件 |
| include | RegExp \| string[] | `[]` | 需要插桩的文件模式 |
| exclude | RegExp \| string[] | `[/node_modules/, /\.test\./, /\.spec\./]` | 需要排除的文件模式 |
| outputDir | string | `'.coverage'` | 输出目录 |

### 6.2 增强配置

| 选项 | 类型 | 默认值 | 描述 |
|------|------|--------|------|
| enableImpactAnalysis | boolean | `true` | 是否启用影响范围分析 |
| enableOverlay | boolean | `true` | 是否启用运行时小气泡 |
| threshold | number | `80` | 增量覆盖率阈值 (%) |
| autoResetCoverage | boolean | `false` | 是否与其他插件联动自动重置覆盖率 |

### 6.3 联动配置

| 选项 | 类型 | 默认值 | 描述 |
|------|------|--------|------|
| apiTracker | object | `{ enable: false }` | 与API追踪插件的联动配置 |
| apiTracker.enable | boolean | `false` | 是否启用API追踪联动 |
| apiTracker.snapshotPath | string | `'./.api-tracker/api-snapshot.json'` | API快照文件路径 |
| apiTracker.onApiChange | string | `'warn'` | API变更时的行为 ('reset' \| 'warn') |

## 7. 与其他插件的协同

### 7.1 独立运行模式
webpack-coverage-plugin 可以独立运行，不依赖其他插件，提供完整的覆盖率收集和报告生成功能。

### 7.2 联动运行模式
当与 webpack-api-tracker-plugin 配合使用时，可以通过配置实现以下功能：
- 接收API变更通知
- 自动重置受影响文件的覆盖率数据
- 在报告中显示API变更影响

## 8. 安全与隐私

### 8.1 数据存储
- 所有覆盖率数据仅在本地存储
- 不会上传到任何远程服务器
- 生成的报告仅保存在本地文件系统中

### 8.2 敏感信息处理
- 不会收集或存储任何个人身份信息
- Git信息仅用于报告标识，不会外传
- 硬件信息仅用于环境标识，不会外传

## 9. 文档要求

### 9.1 README 文档
- 提供项目概述和核心功能介绍
- 包含安装和使用指南
- 提供详细的 API 文档和使用示例
- 包含贡献指南和许可证信息

### 9.2 API 文档
- 为插件配置选项提供详细的说明文档
- 包含使用示例和配置选项说明
- 提供 Webpack 集成指南
- 支持 TypeScript 类型提示

### 9.3 使用示例
- 提供完整的 Webpack 配置使用示例
- 包含常见场景的解决方案
- 提供最佳实践指导
- 包含错误处理示例

### 9.4 更新日志
- 遵循标准的 CHANGELOG 格式
- 记录每个版本的功能新增、bug修复和破坏性变更
- 提供升级指南和兼容性说明

## 10. 发布和版本管理

### 10.1 版本规范
- 遵循语义化版本规范（SemVer）
- 主版本号：不兼容的API修改
- 次版本号：向下兼容的功能性新增
- 修订号：向下兼容的问题修正

### 10.2 发布流程
- 自动化测试通过后才能发布
- 发布前进行代码审查
- 确保文档和示例代码更新完毕
- 提供详细的更新日志

### 10.3 npm 包管理
- 发布到 npm 公共仓库 (@51jbs/webpack-coverage-plugin)
- 支持 CDN 引入 (unpkg, jsDelivr)
- 提供 UMD、ES Module、CommonJS 等多种格式
- 包含完整的类型定义文件 (index.d.ts)
- 支持 tree-shaking 优化
- 提供 package.json 元数据（keywords, homepage, repository, bugs等）
