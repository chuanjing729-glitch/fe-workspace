---
title: architecture_zh
editLink: true
---

# Incremental Coverage Plugin - æŠ€æœ¯æ¶æ„æ–‡æ¡£

**ç‰ˆæœ¬**: 1.0.0  
**æ›´æ–°æ—¶é—´**: 2025-12-20  
**ä½œè€…**: chuanjing.li

---

## ğŸ“– ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [æ ¸å¿ƒæ¶æ„](#æ ¸å¿ƒæ¶æ„)
3. [æ¨¡å—è®¾è®¡](#æ¨¡å—è®¾è®¡)
4. [æ•°æ®æµ](#æ•°æ®æµ)
5. [API è§„èŒƒ](#api-è§„èŒƒ)
6. [æ‰©å±•ç‚¹](#æ‰©å±•ç‚¹)
7. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## 1. ç³»ç»Ÿæ¦‚è¿°

### 1.1 è®¾è®¡ç›®æ ‡

**æ ¸å¿ƒç†å¿µ**: åŸºäºä¸šç•Œæ ‡å‡†å·¥å…·ï¼Œæ„å»ºè½»é‡ã€å¯é çš„å¢é‡è¦†ç›–ç‡æ’ä»¶

**å…³é”®ç›®æ ‡**:
- âœ… **è½»é‡åŒ–**: ä»£ç é‡ <500 è¡Œ
- âœ… **æ ‡å‡†åŒ–**: ä½¿ç”¨ babel-plugin-istanbul + istanbul-diff
- âœ… **é€šç”¨æ€§**: æ”¯æŒ Webpack/Vite/Rollup ç­‰å¤šç§æ„å»ºå·¥å…·
- âœ… **å¯ç»´æŠ¤**: æ¨¡å—åŒ–è®¾è®¡ï¼ŒèŒè´£æ¸…æ™°
- âœ… **æ˜“ç”¨æ€§**: é›¶é…ç½®å³å¯ä½¿ç”¨ï¼Œé…ç½®çµæ´»

### 1.2 æŠ€æœ¯é€‰å‹

| æŠ€æœ¯ | ç”¨é€” | ç†ç”± |
|------|------|------|
| **babel-plugin-istanbul** | ä»£ç æ’æ¡© | ä¸šç•Œæ ‡å‡†ï¼Œ10M+ æœˆä¸‹è½½é‡ |
| **istanbul-diff** | å¢é‡è®¡ç®— | ä¸“é—¨ç”¨äºå¢é‡è¦†ç›–ç‡ |
| **unplugin** | æ„å»ºå·¥å…·é€‚é… | ä¸€æ¬¡ç¼–å†™ï¼Œå¤šå¤„è¿è¡Œ |
| **simple-git** | Git é›†æˆ | ç®€å•å¯é çš„ Git æ“ä½œ |
| **TypeScript** | ç±»å‹å®‰å…¨ | æé«˜ä»£ç è´¨é‡å’Œå¯ç»´æŠ¤æ€§ |

### 1.3 æ¶æ„åŸåˆ™

1. **å•ä¸€èŒè´£**: æ¯ä¸ªæ¨¡å—åªåšä¸€ä»¶äº‹
2. **ä¾èµ–å€’ç½®**: ä¾èµ–æŠ½è±¡è€Œéå…·ä½“å®ç°
3. **å¼€é—­åŸåˆ™**: å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­
4. **æœ€å°æƒŠè®¶**: API è®¾è®¡ç¬¦åˆç›´è§‰
5. **æ¸è¿›å¢å¼º**: æ ¸å¿ƒåŠŸèƒ½ç®€å•ï¼Œé«˜çº§åŠŸèƒ½å¯é€‰

---

## 2. æ ¸å¿ƒæ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·é¡¹ç›®                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  Webpack     â”‚   æˆ–    â”‚    Vite      â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                        â”‚                      â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                      â”‚                                   â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚         â”‚  Incremental Coverage   â”‚                     â”‚
â”‚         â”‚       Plugin            â”‚                     â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚              â”‚              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚ Babel Plugin â”‚ â”‚ Coverage â”‚ â”‚   Report   â”‚
â”‚  Istanbul    â”‚ â”‚ Collectorâ”‚ â”‚  Generator â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚              â”‚              â”‚
        â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
        â”‚     â”‚  Coverage       â”‚     â”‚
        â”‚     â”‚   Differ        â”‚     â”‚
        â”‚     â”‚ (istanbul-diff) â”‚     â”‚
        â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
        â”‚              â”‚              â”‚
        â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
        â”‚     â”‚   Git Service   â”‚     â”‚
        â”‚     â”‚  (simple-git)   â”‚     â”‚
        â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
        â”‚                             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  HTML / JSON   â”‚
              â”‚    Reports     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Plugin Layer (æ’ä»¶å±‚)               â”‚  â† unplugin é€‚é…å±‚
â”‚  - webpack.ts                        â”‚
â”‚  - vite.ts                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Core Layer (æ ¸å¿ƒå±‚)                 â”‚  â† ä¸šåŠ¡é€»è¾‘å±‚
â”‚  - plugin.ts (ä¸»æ§åˆ¶å™¨)              â”‚
â”‚  - collector.ts (æ•°æ®æ”¶é›†)           â”‚
â”‚  - differ.ts (å·®å¼‚è®¡ç®—)              â”‚
â”‚  - reporter.ts (æŠ¥å‘Šç”Ÿæˆ)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Infrastructure Layer (åŸºç¡€è®¾æ–½å±‚)   â”‚  â† å·¥å…·å’ŒæœåŠ¡
â”‚  - git.ts (Git æ“ä½œ)                 â”‚
â”‚  - types.ts (ç±»å‹å®šä¹‰)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. æ¨¡å—è®¾è®¡

### 3.1 Plugin (ä¸»æ§åˆ¶å™¨)

**èŒè´£**: 
- åˆå§‹åŒ–å„ä¸ªæ¨¡å—
- åè°ƒæ¨¡å—é—´çš„äº¤äº’
- æä¾›ç»Ÿä¸€çš„é…ç½®æ¥å£

**å…³é”®æ–¹æ³•**:
```typescript
class IncrementalCoveragePlugin {
  // åˆå§‹åŒ–æ’ä»¶
  constructor(options: IncrementalCoverageOptions)
  
  // Webpack é’©å­
  webpack(compiler: Compiler): void
  
  // Vite é’©å­
  vite: {
    configResolved(config): void
    configureServer(server): void
  }
}
```

**è®¾è®¡è¦ç‚¹**:
- ä½¿ç”¨ unplugin å®ç°è·¨æ„å»ºå·¥å…·å…¼å®¹
- é…ç½®åˆå¹¶é‡‡ç”¨æµ…æ‹·è´ + ç”¨æˆ·é…ç½®è¦†ç›–
- å»¶è¿Ÿåˆå§‹åŒ–ï¼šåªåœ¨éœ€è¦æ—¶åˆ›å»ºæ¨¡å—å®ä¾‹

### 3.2 CoverageCollector (è¦†ç›–ç‡æ”¶é›†å™¨)

**èŒè´£**:
- æ¥æ”¶æµè§ˆå™¨ä¸ŠæŠ¥çš„è¦†ç›–ç‡æ•°æ®
- åˆå¹¶å¤šæ¬¡ä¸ŠæŠ¥çš„æ•°æ®
- ç»´æŠ¤å…¨å±€è¦†ç›–ç‡çŠ¶æ€

**æ ¸å¿ƒç®—æ³•**:
```typescript
merge(newCoverage: CoverageMap): CoverageMap {
  // 1. éå†æ–°æ•°æ®çš„æ¯ä¸ªæ–‡ä»¶
  for (const [file, data] of Object.entries(newCoverage)) {
    if (!this.coverageMap[file]) {
      // é¦–æ¬¡å‡ºç°çš„æ–‡ä»¶ï¼Œç›´æ¥å­˜å‚¨
      this.coverageMap[file] = data;
    } else {
      // å·²å­˜åœ¨çš„æ–‡ä»¶ï¼Œåˆå¹¶è®¡æ•°
      this.mergeCoverageData(this.coverageMap[file], data);
    }
  }
  return this.coverageMap;
}
```

**åˆå¹¶ç­–ç•¥**:
- **è¯­å¥è¦†ç›–**: è®¡æ•°ç´¯åŠ  `s[id] += newS[id]`
- **å‡½æ•°è¦†ç›–**: è®¡æ•°ç´¯åŠ  `f[id] += newF[id]`
- **åˆ†æ”¯è¦†ç›–**: æ•°ç»„å…ƒç´ ç´¯åŠ  `b[id][i] += newB[id][i]`

### 3.3 CoverageDiffer (å·®å¼‚è®¡ç®—å™¨)

**èŒè´£**:
- åŠ è½½ baseline è¦†ç›–ç‡
- ä½¿ç”¨ istanbul-diff è®¡ç®—å·®å¼‚
- ç»“åˆ Git diff è·å–å˜æ›´è¡Œ
- è®¡ç®—å¢é‡è¦†ç›–ç‡

**è®¡ç®—æµç¨‹**:
```
1. åŠ è½½ baseline
   â†“
2. istanbul-diff.diff(baseline, current)
   â†“
3. getGitDiff() è·å–å˜æ›´æ–‡ä»¶å’Œè¡Œå·
   â†“
4. å¯¹æ¯ä¸ªå˜æ›´æ–‡ä»¶ï¼š
   - è·å–å˜æ›´çš„è¡Œå·
   - æ£€æŸ¥è¿™äº›è¡Œæ˜¯å¦è¢«è¦†ç›–
   - è®¡ç®—è¦†ç›–ç‡ç™¾åˆ†æ¯”
   â†“
5. æ±‡æ€»æ•´ä½“è¦†ç›–ç‡
   â†“
6. ä¿å­˜æ–° baselineï¼ˆå¯é€‰ï¼‰
```

**å…³é”®ç®—æ³•**:
```typescript
getUncoveredLines(coverage: CoverageData, changedLines: number[]): number[] {
  const uncovered: number[] = [];
  
  for (const line of changedLines) {
    let isCovered = false;
    
    // æ£€æŸ¥æ˜¯å¦æœ‰è¯­å¥è¦†ç›–è¿™ä¸€è¡Œ
    for (const [stmtId, loc] of Object.entries(coverage.statementMap)) {
      if (loc.start.line <= line && loc.end.line >= line) {
        if (coverage.s[stmtId] > 0) {
          isCovered = true;
          break;
        }
      }
    }
    
    if (!isCovered) {
      uncovered.push(line);
    }
  }
  
  return uncovered;
}
```

### 3.4 CoverageReporter (æŠ¥å‘Šç”Ÿæˆå™¨)

**èŒè´£**:
- ç”Ÿæˆ HTML æŠ¥å‘Š
- ç”Ÿæˆ JSON æŠ¥å‘Š
- æ§åˆ¶å°è¾“å‡ºæ‘˜è¦

**æŠ¥å‘Šæ ¼å¼**:

**HTML æŠ¥å‘Š**:
- å“åº”å¼è®¾è®¡
- æ¸å˜è‰²å¤´éƒ¨
- å¡ç‰‡å¼ç»Ÿè®¡
- æ–‡ä»¶åˆ—è¡¨è¯¦æƒ…

**JSON æŠ¥å‘Š**:
```json
{
  "overall": {
    "totalLines": 100,
    "coveredLines": 80,
    "coverageRate": 80
  },
  "files": [
    {
      "file": "src/utils.ts",
      "changedLines": [10, 11, 12],
      "uncoveredLines": [11],
      "coverageRate": 66.67
    }
  ],
  "timestamp": 1703001234567
}
```

### 3.5 GitService (Git æœåŠ¡)

**èŒè´£**:
- è·å– Git diff
- è§£æ diff è¾“å‡º
- æå–å˜æ›´çš„è¡Œå·

**Diff è§£æç®—æ³•**:
```typescript
parseDiff(diffText: string): { additions: number[], deletions: number[] } {
  // 1. æŒ‰è¡Œåˆ†å‰²
  const lines = diffText.split('\n');
  
  // 2. æŸ¥æ‰¾ hunk header (@@ -old +new @@)
  // 3. è§£æèµ·å§‹è¡Œå·
  // 4. éå†æ¯ä¸€è¡Œï¼š
  //    - '+' å¼€å¤´ â†’ æ–°å¢è¡Œ
  //    - '-' å¼€å¤´ â†’ åˆ é™¤è¡Œ
  //    - ' ' å¼€å¤´ â†’ ä¸Šä¸‹æ–‡è¡Œ
  // 5. è¿”å›è¡Œå·æ•°ç»„
}
```

---

## 4. æ•°æ®æµ

### 4.1 å®Œæ•´æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·ä¿®æ”¹ä»£ç   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Webpack/Vite æ„å»º    â”‚
â”‚  + babel-plugin-      â”‚
â”‚    istanbul æ’æ¡©      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æµè§ˆå™¨æ‰§è¡Œä»£ç        â”‚
â”‚  æ”¶é›† window.        â”‚
â”‚  __coverage__        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼ (POST /coverage)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HTTP ä¸­é—´ä»¶         â”‚
â”‚  æ¥æ”¶è¦†ç›–ç‡æ•°æ®       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CoverageCollector   â”‚
â”‚  åˆå¹¶è¦†ç›–ç‡æ•°æ®       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CoverageDiffer      â”‚
â”‚  1. åŠ è½½ baseline    â”‚
â”‚  2. istanbul-diff    â”‚
â”‚  3. Git diff         â”‚
â”‚  4. è®¡ç®—å¢é‡         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CoverageReporter    â”‚
â”‚  ç”Ÿæˆ HTML/JSON      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¾“å‡ºæŠ¥å‘Š            â”‚
â”‚  - .coverage/        â”‚
â”‚    latest.html       â”‚
â”‚  - æ§åˆ¶å°æ‘˜è¦         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 å…³é”®æ•°æ®ç»“æ„

**CoverageMap** (Istanbul æ ‡å‡†æ ¼å¼):
```typescript
{
  "src/utils.ts": {
    "path": "src/utils.ts",
    "statementMap": {
      "0": { "start": { "line": 1, "column": 0 }, "end": { "line": 1, "column": 20 } }
    },
    "fnMap": { ... },
    "branchMap": { ... },
    "s": { "0": 5 },  // è¯­å¥æ‰§è¡Œæ¬¡æ•°
    "f": { "0": 3 },  // å‡½æ•°æ‰§è¡Œæ¬¡æ•°
    "b": { "0": [2, 1] }  // åˆ†æ”¯æ‰§è¡Œæ¬¡æ•°
  }
}
```

**IncrementalCoverageResult**:
```typescript
{
  "overall": {
    "totalLines": 100,
    "coveredLines": 80,
    "coverageRate": 80
  },
  "files": [
    {
      "file": "src/utils.ts",
      "changedLines": [10, 11, 12],
      "uncoveredLines": [11],
      "coverageRate": 66.67
    }
  ],
  "changedFiles": ["src/utils.ts", "src/helper.ts"],
  "timestamp": 1703001234567
}
```

---

## 5. API è§„èŒƒ

### 5.1 é…ç½® API

```typescript
interface IncrementalCoverageOptions {
  // æ–‡ä»¶åŒ…å«æ¨¡å¼ï¼ˆglobï¼‰
  include?: string[];  // é»˜è®¤: ['src/**']
  
  // æ–‡ä»¶æ’é™¤æ¨¡å¼ï¼ˆglobï¼‰
  exclude?: string[];  // é»˜è®¤: ['**/*.spec.ts', '**/*.test.ts']
  
  // Git å¯¹æ¯”åŸºå‡†åˆ†æ”¯
  gitDiffBase?: string;  // é»˜è®¤: 'main'
  
  // æŠ¥å‘Šè¾“å‡ºç›®å½•
  outputDir?: string;  // é»˜è®¤: '.coverage'
  
  // æŠ¥å‘Šæ ¼å¼
  reportFormat?: 'html' | 'json' | 'both';  // é»˜è®¤: 'html'
  
  // å¯ç”¨æµè§ˆå™¨ UI
  enableOverlay?: boolean;  // é»˜è®¤: true
  
  // Baseline æ–‡ä»¶è·¯å¾„
  baselinePath?: string;  // é»˜è®¤: '.coverage/baseline.json'
  
  // è‡ªåŠ¨ä¿å­˜ baseline
  autoSaveBaseline?: boolean;  // é»˜è®¤: true
  
  // è¦†ç›–ç‡é˜ˆå€¼
  threshold?: number;  // é»˜è®¤: 80
}
```

### 5.2 ä½¿ç”¨ç¤ºä¾‹

**Webpack**:
```javascript
const { WebpackIncrementalCoveragePlugin } = require('@51jbs/incremental-coverage-plugin/webpack');

module.exports = {
  plugins: [
    new WebpackIncrementalCoveragePlugin({
      include: ['src/**'],
      gitDiffBase: 'main',
      threshold: 80,
    })
  ]
};
```

**Vite**:
```javascript
import { ViteIncrementalCoveragePlugin } from '@51jbs/incremental-coverage-plugin/vite';

export default {
  plugins: [
    ViteIncrementalCoveragePlugin({
      include: ['src/**'],
      gitDiffBase: 'develop',
    })
  ]
};
```

---

## 6. æ‰©å±•ç‚¹

### 6.1 è‡ªå®šä¹‰æŠ¥å‘Šæ ¼å¼

```typescript
class CustomReporter extends CoverageReporter {
  async generate(result: IncrementalCoverageResult): Promise<void> {
    // è‡ªå®šä¹‰æŠ¥å‘Šé€»è¾‘
    await this.generateMarkdown(result);
  }
  
  private async generateMarkdown(result: IncrementalCoverageResult): Promise<void> {
    // ç”Ÿæˆ Markdown æ ¼å¼æŠ¥å‘Š
  }
}
```

### 6.2 è‡ªå®šä¹‰ Diff ç­–ç•¥

```typescript
class CustomDiffer extends CoverageDiffer {
  async calculate(coverage: CoverageMap): Promise<IncrementalCoverageResult> {
    // è‡ªå®šä¹‰å·®å¼‚è®¡ç®—é€»è¾‘
    // ä¾‹å¦‚ï¼šåªå…³æ³¨ç‰¹å®šç›®å½•çš„å˜æ›´
  }
}
```

### 6.3 æ’ä»¶é’©å­

```typescript
// æœªæ¥å¯ä»¥æ·»åŠ çš„é’©å­
interface PluginHooks {
  onCoverageCollected?: (coverage: CoverageMap) => void;
  onDiffCalculated?: (result: IncrementalCoverageResult) => void;
  onReportGenerated?: (reportPath: string) => void;
}
```

---

## 7. æœ€ä½³å®è·µ

### 7.1 æ€§èƒ½ä¼˜åŒ–

1. **å»¶è¿ŸåŠ è½½**: åªåœ¨éœ€è¦æ—¶åŠ è½½æ¨¡å—
2. **ç¼“å­˜ç­–ç•¥**: ç¼“å­˜ Git diff ç»“æœ
3. **é˜²æŠ–å¤„ç†**: é¿å…é¢‘ç¹ç”ŸæˆæŠ¥å‘Š
4. **å¢é‡æ›´æ–°**: åªå¤„ç†å˜æ›´çš„æ–‡ä»¶

### 7.2 é”™è¯¯å¤„ç†

```typescript
try {
  const baseline = this.loadBaseline();
} catch (error) {
  console.warn('[CoverageDiffer] æ— æ³•åŠ è½½ baseline:', error);
  // ä½¿ç”¨ç©º baseline ç»§ç»­
  return this.createEmptyBaseline();
}
```

### 7.3 æ—¥å¿—è§„èŒƒ

```typescript
// ä½¿ç”¨ç»Ÿä¸€çš„æ—¥å¿—å‰ç¼€
console.log('[PluginName] æ“ä½œæè¿°');
console.warn('[PluginName] è­¦å‘Šä¿¡æ¯');
console.error('[PluginName] é”™è¯¯ä¿¡æ¯');
```

### 7.4 æµ‹è¯•ç­–ç•¥

1. **å•å…ƒæµ‹è¯•**: æµ‹è¯•æ¯ä¸ªæ¨¡å—çš„æ ¸å¿ƒé€»è¾‘
2. **é›†æˆæµ‹è¯•**: æµ‹è¯•æ¨¡å—é—´çš„åä½œ
3. **ç«¯åˆ°ç«¯æµ‹è¯•**: æµ‹è¯•å®Œæ•´çš„å·¥ä½œæµ

---

## 8. è®¾è®¡å†³ç­–è®°å½•

### 8.1 ä¸ºä»€ä¹ˆé€‰æ‹© unpluginï¼Ÿ

**å†³ç­–**: ä½¿ç”¨ unplugin è€Œä¸æ˜¯åˆ†åˆ«å®ç° webpack/vite æ’ä»¶

**ç†ç”±**:
- âœ… ä¸€æ¬¡ç¼–å†™ï¼Œå¤šå¤„è¿è¡Œ
- âœ… å‡å°‘é‡å¤ä»£ç 
- âœ… ç»Ÿä¸€çš„ API è®¾è®¡
- âœ… ç¤¾åŒºæ”¯æŒå¥½

**æƒè¡¡**:
- âŒ å¢åŠ ä¸€ä¸ªä¾èµ–
- âŒ å­¦ä¹ æˆæœ¬ç¨é«˜

### 8.2 ä¸ºä»€ä¹ˆä½¿ç”¨ istanbul-diffï¼Ÿ

**å†³ç­–**: ä½¿ç”¨ istanbul-diff è€Œä¸æ˜¯è‡ªå·±å®ç°

**ç†ç”±**:
- âœ… ç»è¿‡éªŒè¯çš„ç®—æ³•
- âœ… å¤„ç†è¾¹ç•Œæƒ…å†µ
- âœ… æ ‡å‡†åŒ–è¾“å‡º
- âœ… å‡å°‘ç»´æŠ¤æˆæœ¬

**æƒè¡¡**:
- âŒ ä¾èµ–å¤–éƒ¨åº“
- âŒ è¾“å‡ºæ ¼å¼å›ºå®š

### 8.3 ä¸ºä»€ä¹ˆåˆ†ç¦» Collector å’Œ Differï¼Ÿ

**å†³ç­–**: å°†æ•°æ®æ”¶é›†å’Œå·®å¼‚è®¡ç®—åˆ†ç¦»

**ç†ç”±**:
- âœ… å•ä¸€èŒè´£åŸåˆ™
- âœ… æ˜“äºæµ‹è¯•
- âœ… å¯ç‹¬ç«‹æ›¿æ¢
- âœ… é€»è¾‘æ¸…æ™°

---

## 9. æœªæ¥è§„åˆ’

### 9.1 çŸ­æœŸï¼ˆv1.1ï¼‰
- [ ] æµè§ˆå™¨ overlay UI
- [ ] å®æ—¶è¦†ç›–ç‡æ›´æ–°
- [ ] æ›´ä¸°å¯Œçš„æŠ¥å‘Šæ ·å¼

### 9.2 ä¸­æœŸï¼ˆv1.2ï¼‰
- [ ] æ”¯æŒæ›´å¤šæ„å»ºå·¥å…·ï¼ˆRollup, esbuildï¼‰
- [ ] è¦†ç›–ç‡è¶‹åŠ¿å›¾
- [ ] CI/CD é›†æˆ

### 9.3 é•¿æœŸï¼ˆv2.0ï¼‰
- [ ] äº‘ç«¯æœåŠ¡
- [ ] å›¢é˜Ÿåä½œ
- [ ] æ™ºèƒ½æµ‹è¯•æ¨è

---

## 10. å‚è€ƒèµ„æ–™

- [babel-plugin-istanbul](https://github.com/istanbuljs/babel-plugin-istanbul)
- [istanbul-diff](https://github.com/istanbuljs/istanbul-diff)
- [unplugin](https://github.com/unjs/unplugin)
- [Istanbul Coverage Format](https://github.com/istanbuljs/istanbuljs/blob/master/packages/istanbul-lib-coverage/lib/file-coverage.js)

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0  
**æœ€åæ›´æ–°**: 2025-12-20  
**ç»´æŠ¤è€…**: chuanjing729
