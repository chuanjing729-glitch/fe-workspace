# 📄 产品需求文档 (PRD) - Webpack Coverage Plugin

**Version**: 3.0.0 (Extreme Detail)
**Date**: 2025-12-20
**Status**: Formal Standard

## 1. 产品背景与愿景 (Context & Vision)

在现代大前端开发体系中，"高质量交付" 的压力日益增大。传统的单元测试覆盖率通常在 CI/CD 阶段才被计算，导致开发者在本地编码时处于 "黑盒测试" 状态。

**Webpack Coverage Plugin** 的愿景是打造前端开发的 "代码 X 光机"：
*   **实时性**: 消除测试反馈的各种延迟。
*   **可视化**: 让看不见的逻辑分支变成看得见的颜色色块。
*   **工程化**: 适配从单纯的 SPA 到复杂的 Monorepo/微前端等各种工业级架构。

---

## 2. 用户画像与业务场景 (Personas & Business Scenarios)

### 2.1 深度用户画像
1.  **特性开发工程师 (Feature Dev)**: 关注于通过 UI 交互快速验证新写的 `if/else` 是否跑通。
2.  **存量重构工程师 (Refactor Dev)**: 关注于修改旧代码后，通过对比覆盖率确保关键逻辑路径没有被意外丢失。
3.  **QA 自动化工程师 (QA Automation)**: 利用插件上报的 API，统计自动化脚本在浏览器端运行后的真实代码覆盖率，而不仅仅是黑盒 API 覆盖。
4.  **架构师 (Architect)**: 关注于团队整体的测试水位，通过生成的归档报告对项目质量进行长期度量。

### 2.2 全场景业务方案 (Comprehensive Scenarios)

#### S-01: 复杂组件状态覆盖 (Complex Component States)
*   **场景**: 一个包含 20 种状态机的流程图编辑组件。
*   **操作**: 拖拽、撤销、重做、导出。
*   **需求**: 每一项交互对应的内部状态变更逻辑（State Mutation）必须被追踪并标记。

#### S-02: 异步边界与拦截测试 (Async & Edge Interception)
*   **场景**: 用户的余额充值功能，涉及 3 个连续的网络请求。
*   **操作**: 模拟第一个请求成功，第二个请求 504 超时，第三个请求被用户取消。
*   **需求**: 插件需显示 `finally` 块中的清理逻辑、`retry` 逻辑以及 `AbortController` 触发后的逻辑覆盖。

#### S-03: Monorepo 跨包调用 (Monorepo Cross-Package Calls)
*   **场景**: 在 `packages/core` 中修改了鉴权中间件，在 `apps/admin-dashboard` 中运行项目。
*   **需求**: 插件需能自动识别主应用引用的本地 Symlink 包的变动。报告中需聚合展示主应用与关联子包的覆盖率。

#### S-04: 微前端 (Qiankun / Module Federation)
*   **场景**: 主应用 (Master) 动态加载子应用 (Micro)。子应用部分逻辑在主应用运行时环境中执行。
*   **需求**: 插件需支持分布式上报，通过统一的 `__coverage_upload` 网关汇总不同独立子应用的覆盖率。

#### S-05: 遗留系统重写 (Legacy Rewrite)
*   **场景**: 将 jQuery/Vue2 遗留代码迁移至 Vue3。
*   **需求**: 插件提供 "覆盖率基准线 (Baseline)" 功能。开发者可以在旧系统中通过操作记录 100% 覆盖，然后在重写后的系统中复刻操作，对比是否达到了同样的逻辑深度。

---

## 3. 功能需求详述 (Specific Requirements)

### 3.1 构建架构需求
| 编号 | 模块 | 核心需求描述 | 关键指标 |
|---|---|---|---|
| **F-01** | **插桩引擎** | 支持多种 AST 解析器，适配 `.vue`, `.jsx`, `.svelte`, `.ts` 等全生态源码。 | 语法解析成功率 99.9% |
| **F-02** | **Sourcemap 链路** | 确保经过 Instrumenter 处理后，原始 Sourcemap 的位置偏移被正确修正。 | 报错堆栈映射误差 < 1行 |
| **F-03** | **Git 增量追踪** | 动态计算基于 `fork-point` 或 `HEAD` 的代码 Diff。 | Diff 计算耗时 < 500ms |

### 3.2 运行时交互需求
| 编号 | 模块 | 核心需求描述 | 关键指标 |
|---|---|---|---|
| **F-04** | **气泡 UI 状态** | 5 级颜色预警 (N/A, <30%, <60%, <90%, 100%)。 | 显现延迟 < 100ms |
| **F-05** | **详情 Modal** | 文件列表支持搜索、过滤、按覆盖率倒序排列。展示变动行的行号区间。 | 搜索响应时间 < 50ms |
| **F-06** | **上报协议** | 采用 Chunked 上报或压缩上报，支持配置多上报目标 (Multiple Reporting Targets)。 | 报文压缩比 > 70% |

### 3.3 企业级集成需求
| 编号 | 模块 | 核心需求描述 | 优先级 |
|---|---|---|---|
| **F-07** | **团队看板集成** | 支持上报覆盖率数据到核心监控中台。 | P2 |
| **F-08** | **CI Lint 门禁** | 支持通过 CLI 参数配置 `threshold`，若本地修改覆盖率未达标则在 `pre-commit` 阶段报错。 | P1 |

---

## 4. 验收标准 & 质量矩阵 (AC & Matrix)

### 4.1 核心验收 (General AC)
*   **AC-01**: 在 10W 行代码规模的应用中，启动过程无明显卡顿，内存增长波动在 100MB 以内。
*   **AC-02**: 准确标记 Optional Chaining (`?.`) 的逻辑短路情况。
*   **AC-03**: 当两个开发者同时在本地运行插件时，DevServer 能够根据会话 ID 隔离各自的覆盖率。

---

## 5. 风险与约束 (Risks & Constraints)
*   **内存泄露风险**: 在极大型项目且长期不停服务的情况下，Coverage 对象会持续增大。**对策**: 引入 TTL 清理机制。
*   **构建冲突风险**: 与其他修改源代码的插件（如混淆器、特定语法的 polyfill）可能存在顺序依赖。**对策**: 明确指定插件 Hooks 顺序。
