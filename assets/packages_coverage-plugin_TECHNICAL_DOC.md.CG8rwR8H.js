import{_ as p,C as A,c as d,o as r,a3 as t,b as i,j as c,w as a,a as s,G as o,a4 as l}from"./chunks/framework.KoSEt7m1.js";const _=JSON.parse('{"title":"TECHNICAL_DOC","description":"","frontmatter":{"title":"TECHNICAL_DOC","editLink":true},"headers":[],"relativePath":"packages/coverage-plugin/TECHNICAL_DOC.md","filePath":"packages/coverage-plugin/TECHNICAL_DOC.md"}'),E={name:"packages/coverage-plugin/TECHNICAL_DOC.md"};function u(g,e,C,v,B,h){const n=A("Mermaid");return r(),d("div",null,[e[3]||(e[3]=t('<h1 id="技术架构文档-technical-documentation" tabindex="-1">技术架构文档 (Technical Documentation) <a class="header-anchor" href="#技术架构文档-technical-documentation" aria-label="Permalink to &quot;技术架构文档 (Technical Documentation)&quot;">​</a></h1><h2 id="_1-架构概览-architecture-overview" tabindex="-1">1. 架构概览 (Architecture Overview) <a class="header-anchor" href="#_1-架构概览-architecture-overview" aria-label="Permalink to &quot;1. 架构概览 (Architecture Overview)&quot;">​</a></h2><p>本插件采用 <strong>Universal Plugin Architecture (通用插件架构)</strong> 结合 <strong>Clean Architecture (整洁架构)</strong> 设计。旨在通过一套核心逻辑同时支持 Webpack, Vite, Rollup, Rspack 等多种构建工具。</p><h3 id="核心分层" tabindex="-1">核心分层 <a class="header-anchor" href="#核心分层" aria-label="Permalink to &quot;核心分层&quot;">​</a></h3><ul><li><strong>Core Layer (<code>src/core</code>)</strong>: <ul><li><strong>Entity (Types/Interfaces)</strong>: 定义核心业务实体和接口。</li><li><strong>Use Cases (<code>PluginCore</code>)</strong>: 封装平台无关的业务流程 (<code>init</code>, <code>transform</code>, <code>generateReport</code>)。</li></ul></li><li><strong>Service Layer (<code>src/services</code>)</strong>: 实现具体的业务逻辑 (<code>GitService</code>, <code>CoverageService</code>)。依赖 Core 接口。</li><li><strong>Adapter Layer (<code>src/unplugin.ts</code>, <code>src/vite.ts</code>, <code>src/rspack.ts</code>, <code>src/index.ts</code>)</strong>: <ul><li>使用 <code>unplugin</code> 抹平不同构建工具的钩子差异。</li><li>为 Webpack 和 Vite 提供特定的兼容性适配器。</li></ul></li><li><strong>Infrastructure Layer (<code>src/infra</code>)</strong>: 处理外部依赖和具体实现 (UI生成, 文件存储, HTTP服务)。</li></ul><h3 id="架构图-class-diagram" tabindex="-1">架构图 (Class Diagram) <a class="header-anchor" href="#架构图-class-diagram" aria-label="Permalink to &quot;架构图 (Class Diagram)&quot;">​</a></h3>',6)),(r(),i(l,null,{default:a(()=>[o(n,{id:"mermaid-61",class:"mermaid",graph:"classDiagram%0A%20%20%20%20class%20WebpackCoveragePlugin%20%7B%0A%20%20%20%20%20%20%20%20%2Bapply(compiler)%0A%20%20%20%20%7D%0A%20%20%20%20class%20ViteCoveragePlugin%20%7B%0A%20%20%20%20%20%20%20%20%2BconfigureServer(server)%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20class%20UnpluginFactory%20%7B%0A%20%20%20%20%20%20%20%20%3C%3CFunction%3E%3E%0A%20%20%20%20%20%20%20%20%2BbuildStart()%0A%20%20%20%20%20%20%20%20%2Btransform()%0A%20%20%20%20%20%20%20%20%2BbuildEnd()%0A%20%20%20%20%7D%0A%0A%20%20%20%20class%20CoveragePluginCore%20%7B%0A%20%20%20%20%20%20%20%20%2Binit()%0A%20%20%20%20%20%20%20%20%2Btransform(code%2C%20id)%0A%20%20%20%20%20%20%20%20%2BgenerateReport()%0A%20%20%20%20%7D%0A%0A%20%20%20%20namespace%20Services%20%7B%0A%20%20%20%20%20%20%20%20class%20GitService%0A%20%20%20%20%20%20%20%20class%20CoverageService%0A%20%20%20%20%20%20%20%20class%20AnalysisService%0A%20%20%20%20%20%20%20%20class%20ReportService%0A%20%20%20%20%7D%0A%0A%20%20%20%20namespace%20Infra%20%7B%0A%20%20%20%20%20%20%20%20class%20HttpServer%0A%20%20%20%20%7D%0A%0A%20%20%20%20WebpackCoveragePlugin%20..%3E%20UnpluginFactory%20%3A%20Wraps%20(%E5%B0%81%E8%A3%85)%0A%20%20%20%20ViteCoveragePlugin%20..%3E%20UnpluginFactory%20%3A%20Uses%20(%E4%BD%BF%E7%94%A8)%0A%20%20%20%20UnpluginFactory%20--%3E%20CoveragePluginCore%20%3A%20Delegates%20(%E5%A7%94%E6%89%98%E6%A0%B8%E5%BF%83%E9%80%BB%E8%BE%91)%0A%20%20%20%20%0A%20%20%20%20CoveragePluginCore%20--%3E%20GitService%20%3A%20Injects%20(Git%E6%93%8D%E4%BD%9C)%0A%20%20%20%20CoveragePluginCore%20--%3E%20CoverageService%20%3A%20Injects%20(%E8%A6%86%E7%9B%96%E7%8E%87%E8%AE%A1%E7%AE%97)%0A%20%20%20%20CoveragePluginCore%20--%3E%20AnalysisService%20%3A%20Injects%20(%E4%BE%9D%E8%B5%96%E5%88%86%E6%9E%90)%0A%20%20%20%20CoveragePluginCore%20--%3E%20ReportService%20%3A%20Creates%20(%E6%8A%A5%E5%91%8A%E7%94%9F%E6%88%90)%0A%20%20%20%20CoveragePluginCore%20--%3E%20HttpServer%20%3A%20Manages%20(HTTP%E6%9C%8D%E5%8A%A1)%0A"})]),fallback:a(()=>[...e[0]||(e[0]=[s(" Loading... ",-1)])]),_:1})),e[4]||(e[4]=t(`<h2 id="_2-目录结构说明" tabindex="-1">2. 目录结构说明 <a class="header-anchor" href="#_2-目录结构说明" aria-label="Permalink to &quot;2. 目录结构说明&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>src/</span></span>
<span class="line"><span>├── core/                 # 核心定义 (Core Definitions)</span></span>
<span class="line"><span>│   ├── plugin-core.ts    # 核心业务逻辑 (Platform-agnostic Logic)</span></span>
<span class="line"><span>│   ├── interfaces.ts     # 服务接口 (Interfaces)</span></span>
<span class="line"><span>│   └── types.ts          # 类型定义 (Types)</span></span>
<span class="line"><span>├── services/             # 业务逻辑服务 (Business Services)</span></span>
<span class="line"><span>│   ├── git.service.ts</span></span>
<span class="line"><span>│   ├── coverage.service.ts</span></span>
<span class="line"><span>│   ├── analysis.service.ts</span></span>
<span class="line"><span>│   └── report.service.ts</span></span>
<span class="line"><span>├── infra/                # 基础设施 (Infrastructure)</span></span>
<span class="line"><span>│   ├── http.server.ts    # 通用 HTTP/中间件服务 (Universal HTTP Server)</span></span>
<span class="line"><span>│   ├── storage.ts        # 文件缓存 (File Storage)</span></span>
<span class="line"><span>│   └── report/           # 报告生成器 (Report Generator)</span></span>
<span class="line"><span>├── unplugin.ts           # Unplugin 工厂 (Universal Hooks Factory)</span></span>
<span class="line"><span>├── vite.ts               # Vite 导出适配 (Vite Adapter)</span></span>
<span class="line"><span>└── index.ts              # Webpack 导出适配 (Webpack Adapter)</span></span></code></pre></div><h2 id="_3-核心流程-core-flows" tabindex="-1">3. 核心流程 (Core Flows) <a class="header-anchor" href="#_3-核心流程-core-flows" aria-label="Permalink to &quot;3. 核心流程 (Core Flows)&quot;">​</a></h2><h3 id="_3-1-跨平台插桩流程-instrumentation" tabindex="-1">3.1 跨平台插桩流程 (Instrumentation) <a class="header-anchor" href="#_3-1-跨平台插桩流程-instrumentation" aria-label="Permalink to &quot;3.1 跨平台插桩流程 (Instrumentation)&quot;">​</a></h3>`,4)),(r(),i(l,null,{default:a(()=>[o(n,{id:"mermaid-72",class:"mermaid",graph:"sequenceDiagram%0A%20%20%20%20participant%20Bundler%20as%20Webpack%2FVite%20(%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7)%0A%20%20%20%20participant%20Adapter%20as%20Unplugin%20Adapter%20(%E9%80%82%E9%85%8D%E5%B1%82)%0A%20%20%20%20participant%20Core%20as%20CoveragePluginCore%20(%E6%A0%B8%E5%BF%83%E5%B1%82)%0A%20%20%20%20participant%20Babel%20as%20Babel(Istanbul)%20(%E6%8F%92%E6%A1%A9%E5%B7%A5%E5%85%B7)%0A%0A%20%20%20%20Bundler-%3E%3EAdapter%3A%20transform(code%2C%20id)%0A%20%20%20%20Adapter-%3E%3ECore%3A%20transform(code%2C%20id)%0A%20%20%20%20Core-%3E%3ECore%3A%20shouldInstrument(id)%3F%20(%E6%98%AF%E5%90%A6%E9%9C%80%E8%A6%81%E6%8F%92%E6%A1%A9)%0A%20%20%20%20alt%20Yes%20(%E9%9C%80%E8%A6%81)%0A%20%20%20%20%20%20%20%20Core-%3E%3EBabel%3A%20transformSync(code%2C%20plugins%3D%5Bistanbul%5D)%0A%20%20%20%20%20%20%20%20Babel--%3E%3ECore%3A%20Instrumented%20Code%20(%E6%8F%92%E6%A1%A9%E5%90%8E%E4%BB%A3%E7%A0%81)%0A%20%20%20%20%20%20%20%20Core--%3E%3EAdapter%3A%20code%0A%20%20%20%20else%20No%20(%E4%B8%8D%E9%9C%80%E8%A6%81)%0A%20%20%20%20%20%20%20%20Core--%3E%3EAdapter%3A%20null%20(skip)%0A%20%20%20%20end%0A%20%20%20%20Adapter--%3E%3EBundler%3A%20result%0A"})]),fallback:a(()=>[...e[1]||(e[1]=[s(" Loading... ",-1)])]),_:1})),e[5]||(e[5]=c("h3",{id:"_3-2-增量覆盖率计算流程",tabindex:"-1"},[s("3.2 增量覆盖率计算流程 "),c("a",{class:"header-anchor",href:"#_3-2-增量覆盖率计算流程","aria-label":'Permalink to "3.2 增量覆盖率计算流程"'},"​")],-1)),(r(),i(l,null,{default:a(()=>[o(n,{id:"mermaid-76",class:"mermaid",graph:"sequenceDiagram%0A%20%20%20%20participant%20Browser%20as%20Browser%20UI%2FOverlay%20(%E5%89%8D%E7%AB%AF)%0A%20%20%20%20participant%20Server%20as%20HttpServer%20(%E6%9C%8D%E5%8A%A1%E5%B1%82)%0A%20%20%20%20participant%20Core%20as%20CoverageService%20(%E6%A0%B8%E5%BF%83%E8%AE%A1%E7%AE%97)%0A%20%20%20%20participant%20Git%20as%20GitService%20(Git%E6%9C%8D%E5%8A%A1)%0A%20%20%20%20%0A%20%20%20%20Browser-%3E%3EServer%3A%20POST%20%2F__coverage_upload%0A%20%20%20%20Server-%3E%3ECore%3A%20calculate(runtimeMap)%0A%20%20%20%20%0A%20%20%20%20rect%20rgb(240%2C%20248%2C%20255)%0A%20%20%20%20note%20right%20of%20Core%3A%20Calculation%20Logic%20(%E8%AE%A1%E7%AE%97%E9%80%BB%E8%BE%91)%0A%20%20%20%20Core-%3E%3EGit%3A%20getChangedFiles()%20-%3E%20getFileDiff()%20(%E8%8E%B7%E5%8F%96%E5%8F%98%E6%9B%B4)%0A%20%20%20%20Git--%3E%3ECore%3A%20Diff%20Lines%20(%E5%B7%AE%E5%BC%82%E8%A1%8C)%0A%20%20%20%20Core-%3E%3ECore%3A%20Intersect(Diff%2C%20Runtime)%20(%E8%AE%A1%E7%AE%97%E4%BA%A4%E9%9B%86)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20Core--%3E%3EServer%3A%20IncrementalResult%20(%E5%A2%9E%E9%87%8F%E7%BB%93%E6%9E%9C)%0A%20%20%20%20Server--%3E%3EBrowser%3A%20200%20OK%0A"})]),fallback:a(()=>[...e[2]||(e[2]=[s(" Loading... ",-1)])]),_:1})),e[6]||(e[6]=t('<h2 id="_4-扩展指南" tabindex="-1">4. 扩展指南 <a class="header-anchor" href="#_4-扩展指南" aria-label="Permalink to &quot;4. 扩展指南&quot;">​</a></h2><h3 id="支持新的构建工具-例如-rollup" tabindex="-1">支持新的构建工具 (例如 Rollup) <a class="header-anchor" href="#支持新的构建工具-例如-rollup" aria-label="Permalink to &quot;支持新的构建工具 (例如 Rollup)&quot;">​</a></h3><p>由于基于 <code>unplugin</code>，支持 Rollup 非常简单：</p><ol><li>在 <code>src/</code> 下创建 <code>rollup.ts</code>。</li><li>导出 <code>unplugin.rollup</code>。</li><li>如果需要 DevServer 支持，需研究 Rollup 配置服务的机制并适配 <code>src/infra/http.server.ts</code>。</li></ol><h3 id="适配新的-devserver" tabindex="-1">适配新的 DevServer <a class="header-anchor" href="#适配新的-devserver" aria-label="Permalink to &quot;适配新的 DevServer&quot;">​</a></h3><p>目前的 <code>HttpServer</code> 支持 <code>Express</code> (Webpack) 和 <code>Connect</code> (Vite) 风格的中间件。 如果新的工具使用其他风格 (如 Koa)，需要在 <code>src/infra/http.server.ts</code> 的 <code>install</code> 方法中添加适配逻辑。</p>',6))])}const f=p(E,[["render",u]]);export{_ as __pageData,f as default};
