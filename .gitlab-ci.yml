image: node:20

stages:
  - check
  - build
  - deploy
  - publish

variables:
  PNPM_CACHE_DIR: .pnpm-store

cache:
  key:
    files:
      - pnpm-lock.yaml
  paths:
    - .pnpm-store

before_script:
  - corepack enable
  - corepack prepare pnpm@latest --activate
  - pnpm config set store-dir $PNPM_CACHE_DIR
  - pnpm install --frozen-lockfile

lint-and-test:
  stage: check
  script:
    - pnpm lint
    - pnpm test
  artifacts:
    paths:
      - "**/coverage/"
    expire_in: 1 week

pages:
  stage: deploy
  script:
    - node scripts/sync-package-docs.cjs
    - pnpm docs:build
    - mv docs/.vitepress/dist public
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

publish-packages:
  stage: publish
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual
  script:
    - git config --global user.name "${GITLAB_USER_NAME}"
    - git config --global user.email "${GITLAB_USER_EMAIL}"
    # 设置 NPM 认证 (需在 GitLab CI 变量中配置 NPM_TOKEN)
    - echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > .npmrc
    - |
      if [ -z "$PACKAGE" ]; then
        pnpm -r exec npm version ${VERSION_TYPE:-patch} --no-git-tag-version
        git commit -am "chore: release all ${VERSION_TYPE:-patch}"
        pnpm -r publish --no-git-checks
      else
        pnpm --filter $PACKAGE exec npm version ${VERSION_TYPE:-patch} --no-git-tag-version
        git commit -am "chore: release $PACKAGE ${VERSION_TYPE:-patch}"
        pnpm --filter $PACKAGE publish --no-git-checks
      fi
    - git push "https://project_${CI_PROJECT_ID}_bot:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" HEAD:${CI_COMMIT_BRANCH} --follow-tags